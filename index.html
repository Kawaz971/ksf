<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>KSF Snake ‚Äì Concours</title>
  <meta name="description" content="Mini-jeu Snake pour patienter + Concours jusqu'√† 20h : top 3 scores gagnent un produit apr√®s ajout & tag Instagram @karibeanstreetfood." />
  <style>
    :root{ --ksf-yellow:#FFD400; --ksf-black:#111; --ksf-white:#fff; --ksf-mint:#00F5C8; --radius:18px; }
    *{box-sizing:border-box}
    html,body{height:100%; overscroll-behavior:none}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--ksf-black); background:radial-gradient(900px 480px at 10% 10%, #fff7bd 0%, #fff3a6 35%, #fff 65%); display:flex; align-items:center; justify-content:center; padding:16px; overflow:hidden; touch-action:none}
    .app{width:min(560px,100%)}
    .card{background:var(--ksf-white); border:2px solid var(--ksf-black); border-radius:var(--radius); box-shadow:0 10px 0 var(--ksf-black); overflow:hidden}
    .header{display:flex; align-items:center; gap:12px; background:var(--ksf-yellow); border-bottom:2px solid var(--ksf-black); padding:12px 14px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:900}
    .brand img{width:40px;height:40px;border-radius:12px;border:2px solid var(--ksf-black);background:#fff;object-fit:cover}
    .brand .title{font-size:20px; letter-spacing:.3px}
    .badges{margin-left:auto; display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .badge{font-size:12px; padding:6px 10px; border:2px solid var(--ksf-black); border-radius:999px; background:#fff}

    .contest{display:flex; align-items:center; gap:10px; padding:10px 12px; background:#fff; border-bottom:2px dashed var(--ksf-black)}
    .contest .dot{width:10px; height:10px; border-radius:50%; background:#f33; box-shadow:0 0 0 4px rgba(243,51,51,.15)}
    .contest .text{font-size:14px; line-height:1.35}
    .contest .count{font-weight:800}

    .canvas-wrap{position:relative; background:#fef9d8}
    canvas{width:100%; aspect-ratio:1/1; display:block; image-rendering:pixelated; background:#fffdf0; border-bottom:2px solid var(--ksf-black)}

    .hud{display:flex; justify-content:space-between; align-items:center; gap:8px; padding:10px 12px; border-top:2px dashed var(--ksf-black); background:#fff}
    .scores{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .chip{border:2px solid var(--ksf-black); padding:6px 10px; border-radius:999px; font-weight:800; background:#fff}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    button{cursor:pointer; font-weight:800; border:2px solid var(--ksf-black); border-radius:12px; padding:10px 12px; background:#fff; transition:transform .04s ease; touch-action:manipulation}
    button:active{transform:translateY(1px)}
    .primary{background:var(--ksf-yellow)} .mint{background:var(--ksf-mint)} .ghost{background:#fff}

    .controls{display:grid; grid-template-areas: ". up ." "left down right" "replay replay replay"; grid-template-columns:1fr 1fr 1fr; gap:10px; padding:12px; background:#fff; border-top:2px dashed var(--ksf-black); justify-items:center; align-items:center}
    .controls button{width:68px;height:68px;font-size:22px}
    .controls .up{grid-area:up}
    .controls .down{grid-area:down}
    .controls .left{grid-area:left}
    .controls .right{grid-area:right}
    .controls .replay{grid-area:replay; width:200px; height:52px; font-size:16px}

    .footer{padding:10px 12px; font-size:12px; background:#fff; border-top:2px dashed var(--ksf-black); display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap}

    .overlay{position:absolute; inset:0; display:none; place-items:center; background:rgba(255,255,255,.92)}
    .overlay.active{display:grid}
    .panel{width:min(92%, 480px); background:#fff; border:2px solid var(--ksf-black); border-radius:16px; box-shadow:0 8px 0 var(--ksf-black); padding:16px}
    .panel h2{margin:.2rem 0 0.6rem}
    .panel p{margin:.5rem 0; line-height:1.4}
    .list{padding-left:18px}
    .center{display:flex; justify-content:center; gap:8px; flex-wrap:wrap}
    .small{font-size:12px; opacity:.75}

    .lb-table{width:100%; border-collapse:collapse; margin-top:8px}
    .lb-table th,.lb-table td{border:1px solid #ccc; padding:6px 8px; text-align:left; font-size:14px}
    .lb-table th{background:#fff9cc}
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="header">
        <div class="brand">
          <img id="logo" alt="Logo" />
          <div class="title" id="brandTitle">KSF ‚Äì Mini Snake</div>
        </div>
        <div class="badges">
          <div class="badge">üéÅ Top 3 = 1 produit</div>
          <div class="badge">üì∏ Montre la capture</div>
        </div>
      </div>

      <div class="contest">
        <div class="dot" id="liveDot"></div>
        <div class="text" id="contestText">Concours en cours ‚Ä¢ Fin √† 20:00 ‚Ä¢ Temps restant : <span class="count" id="countdown">--:--:--</span></div>
      </div>

      <div class="canvas-wrap">
        <canvas id="game" width="500" height="500"></canvas>

        <div class="overlay active" id="startOverlay">
          <div class="panel">
            <h2>üéÆ Jouer √† Snake</h2>
            <p>Fais le meilleur score. Les <strong>3 meilleurs</strong> du jour gagnent <strong>1 produit gratuit</strong> apr√®s :</p>
            <ul class="list">
              <li>Avoir ajout√© Instagram <strong>@karibeanstreetfood</strong></li>
              <li>Avoir tagu√© <strong>@karibeanstreetfood</strong> en story</li>
              <li>Montrer la <strong>capture d'√©cran</strong> du score √† la caisse</li>
            </ul>
            <p class="small">Fin du jeu concours √† <strong>20:00</strong> (heure locale). Les scores apr√®s 20:00 ne comptent pas.</p>
            <div class="center" style="margin-top:10px">
              <button class="primary" id="btnStart">‚ñ∂Ô∏è Jouer</button>
              <button class="ghost" id="btnRules">‚ÑπÔ∏è R√®gles</button>
              <a href="https://www.instagram.com/karibeanstreetfood" target="_blank" rel="noopener"><button class="mint">üì≤ Instagram</button></a>
            </div>
          </div>
        </div>

        <div class="overlay" id="rulesOverlay">
          <div class="panel">
            <h2>‚ÑπÔ∏è R√®gles</h2>
            <p>Mange les fruits, √©vite les murs et ta queue. Chaque fruit = <strong>+1</strong>. La vitesse augmente.</p>
            <ul class="list">
              <li><strong>Mobile</strong> : boutons ‚¨ÜÔ∏è‚¨áÔ∏è‚¨ÖÔ∏è‚û°Ô∏è ou balayage</li>
              <li><strong>Pause/Reprendre</strong> : bouton ‚èØÔ∏è / tape l√©ger</li>
              <li><strong>Desktop</strong> : fl√®ches ou ZQSD</li>
            </ul>
            <div class="center" style="margin-top:10px">
              <button class="primary" id="btnBack">OK</button>
            </div>
          </div>
        </div>

        <div class="overlay" id="gameOverOverlay">
          <div class="panel">
            <h2>üí• Perdu !</h2>
            <p id="finalScore">Score : 0</p>
            <p id="bestScore">Meilleur : 0</p>
            <p class="small" id="contestNote">Si c'est avant 20:00, prends une <strong>capture</strong> et passe √† la caisse üì∏</p>
            <div class="center" style="margin-top:10px">
              <button class="primary" id="btnRestart">‚Üª Rejouer</button>
              <button class="mint" id="btnShare">Partager</button>
              <a href="https://www.instagram.com/karibeanstreetfood" target="_blank" rel="noopener"><button class="ghost">üì≤ Ouvrir Instagram</button></a>
            </div>
          </div>
        </div>

        <div class="overlay" id="leaderboardOverlay">
          <div class="panel">
            <h2>üèÜ Classement</h2>
            <table class="lb-table" id="lbTable">
              <thead><tr><th>#</th><th>Score</th><th>Heure</th></tr></thead>
              <tbody></tbody>
            </table>
            <div class="center" style="margin-top:10px">
              <button class="ghost" id="btnCloseLb">Fermer</button>
              <button class="primary" id="btnExportCsv">‚¨áÔ∏è Export CSV</button>
              <button class="mint" id="btnClearLocal">üóëÔ∏è Vider (local)</button>
            </div>
          </div>
        </div>
      </div>

      <div class="hud">
        <div class="scores">
          <div class="chip">Score: <span id="score">0</span></div>
          <div class="chip">Best: <span id="hi">0</span></div>
        </div>
        <div class="actions">
          <button id="btnPause">‚èØÔ∏è Pause</button>
          <button id="btnHow">‚ÑπÔ∏è R√®gles</button>
          <button id="btnLeaderboard">üèÜ Classement</button>
        </div>
      </div>

      <div class="controls" id="controls">
        <button type="button" class="up" data-dir="up">‚¨ÜÔ∏è</button>
        <button type="button" class="down" data-dir="down">‚¨áÔ∏è</button>
        <button type="button" class="left" data-dir="left">‚¨ÖÔ∏è</button>
        <button type="button" class="right" data-dir="right">‚û°Ô∏è</button>
        <button type="button" class="replay" id="btnReplay">‚èØÔ∏è Start / Rejouer</button>
      </div>

      <div class="footer">
        <div>Insta : <strong>@karibeanstreetfood</strong> ‚Ä¢ <strong>@Sowbella_France</strong></div>
        <div class="small">HTML5 offline-ready ‚Ä¢ Pense √† faire une capture üì∏</div>
      </div>
    </div>
  </div>

  <script>
    const CONFIG = {
      brandTitle: 'KSF ‚Äì Mini Snake',
      logoUrl: '',
      grid: 20,
      speedStartMs: 140,
      speedMinMs: 70,
      speedStepScore: 4,
      hiStorageKey: 'ksfSnakeHighScore',
      contestEndHour: 20,
      storageKeySubmissions: 'ksfSnakeSubmissions',
      scoresEndpoint: '', // mettre un Google Apps Script si tu veux mutualiser
      theme: { snake:'#111', head:'#000', fruit:'#ff3b3b', board:'#fffdf0', grid:'#f3e9a2' }
    };

    function getTodayEnd(){ const now=new Date(); return new Date(now.getFullYear(),now.getMonth(),now.getDate(),CONFIG.contestEndHour,0,0,0); }
    let contestEnded=false; const countdownEl=document.getElementById('countdown'); const liveDot=document.getElementById('liveDot');
    function updateCountdown(){ const now=new Date(); const end=getTodayEnd(); if(now>=end){contestEnded=true; countdownEl.textContent='Termin√©'; document.getElementById('contestText').textContent='Concours termin√© ‚Äì rendez-vous demain !'; liveDot.style.background='#888'; document.getElementById('contestNote').textContent='Concours termin√©. Tu peux continuer √† jouer pour le fun !'; return;} const diff=end-now; const h=String(Math.floor(diff/3_600_000)).padStart(2,'0'); const m=String(Math.floor((diff%3_600_000)/60_000)).padStart(2,'0'); const s=String(Math.floor((diff%60_000)/1_000)).padStart(2,'0'); countdownEl.textContent=`${h}:${m}:${s}`; }
    setInterval(updateCountdown,1000); updateCountdown();

    const canvas=document.getElementById('game'); const ctx=canvas.getContext('2d'); let cell; const world={ size: 20 };
    let snake, dir, nextDir, fruit, score, best, timer, speed;
    const scoreEl=document.getElementById('score'); const hiEl=document.getElementById('hi');
    const startOverlay=document.getElementById('startOverlay'); const rulesOverlay=document.getElementById('rulesOverlay'); const gameOverOverlay=document.getElementById('gameOverOverlay');

    const btnStart=document.getElementById('btnStart'); const btnRules=document.getElementById('btnRules'); const btnBack=document.getElementById('btnBack'); const btnRestart=document.getElementById('btnRestart'); const btnShare=document.getElementById('btnShare'); const btnPause=document.getElementById('btnPause'); const btnHow=document.getElementById('btnHow'); const btnReplay=document.getElementById('btnReplay');

    function haptic(ms=20){ if('vibrate' in navigator){ navigator.vibrate(ms); } }
    function loadBest(){ const v=parseInt(localStorage.getItem(CONFIG.hiStorageKey)||'0',10); best=isNaN(v)?0:v; hiEl.textContent=best; }
    function saveBest(){ localStorage.setItem(CONFIG.hiStorageKey, String(best)); }

    function reset(){ snake=[{x:10,y:10},{x:9,y:10},{x:8,y:10}]; dir={x:1,y:0}; nextDir={x:1,y:0}; score=0; scoreEl.textContent=score; speed=CONFIG.speedStartMs; spawnFruit(); draw(); }
    function spawnFruit(){ do{ fruit={ x:Math.floor(Math.random()*world.size), y:Math.floor(Math.random()*world.size) }; } while(snake.some(s=>s.x===fruit.x && s.y===fruit.y)); }
    function drawCell(x,y,color){ ctx.fillStyle=color; ctx.fillRect(x*cell,y*cell,cell,cell); }
    function drawGrid(){ ctx.strokeStyle=CONFIG.theme.grid; ctx.lineWidth=1; for(let i=0;i<=world.size;i++){ ctx.beginPath(); ctx.moveTo(i*cell,0); ctx.lineTo(i*cell, world.size*cell); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0,i*cell); ctx.lineTo(world.size*cell, i*cell); ctx.stroke(); } }
    function draw(){ ctx.fillStyle=CONFIG.theme.board; ctx.fillRect(0,0,canvas.width,canvas.height); drawGrid(); drawCell(fruit.x,fruit.y,CONFIG.theme.fruit); snake.forEach((s,i)=> drawCell(s.x,s.y, i===0?CONFIG.theme.head:CONFIG.theme.snake)); }

    function tick(){ if((nextDir.x!==-dir.x)||(nextDir.y!==-dir.y)) dir=nextDir; const head={x:snake[0].x+dir.x, y:snake[0].y+dir.y}; if(head.x<0||head.y<0||head.x>=world.size||head.y>=world.size||snake.some(s=>s.x===head.x && s.y===head.y)) return gameOver(); snake.unshift(head); if(head.x===fruit.x && head.y===fruit.y){ score++; scoreEl.textContent=score; if(score>best){ best=score; hiEl.textContent=best; saveBest(); } if(score % CONFIG.speedStepScore===0){ speed=Math.max(CONFIG.speedMinMs, speed-10); clearInterval(timer); timer=setInterval(tick, speed); } spawnFruit(); }
