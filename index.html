<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KSF Snake ‚Äì Jouer</title>
  <meta name="description" content="Mini-jeu Snake pour patienter dans la file ‚Äì KSF / Sowbella" />
  <style>
    :root{
      --ksf-yellow:#FFD400;
      --ksf-black:#111111;
      --ksf-white:#ffffff;
      --ksf-accent:#00F5C8;
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%; overscroll-behavior:none}
    body{
      margin:0; background: radial-gradient(1200px 600px at 10% 10%, #fff9d6 0%, #fff3a6 30%, #fff 60%), var(--ksf-white);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial;
      color:var(--ksf-black); display:flex; align-items:center; justify-content:center; padding:16px; overflow:hidden; touch-action:none;
    }
    .app{width:min(520px, 100%);} 
    .card{background:var(--ksf-white); border:2px solid var(--ksf-black); border-radius:var(--radius); box-shadow:0 8px 0 var(--ksf-black); overflow:hidden}
    .header{display:flex; align-items:center; gap:12px; background:var(--ksf-yellow); border-bottom:2px solid var(--ksf-black); padding:12px 14px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.5px}
    .brand img{width:38px;height:38px;border-radius:12px;border:2px solid var(--ksf-black);background:#fff;object-fit:cover}
    .brand .title{font-size:20px}
    .badges{margin-left:auto;display:flex;gap:8px;align-items:center}
    .badge{font-size:12px;padding:6px 10px;border:2px solid var(--ksf-black);border-radius:999px;background:#fff}

    .canvas-wrap{position:relative; aspect-ratio:4/5; background:#fef9d8; display:grid; place-items:center}
    canvas{width:100%;height:100%;image-rendering:pixelated; background:#fffdf0; border-bottom:2px solid var(--ksf-black)}

    .hud{display:flex; justify-content:space-between; align-items:center; gap:8px; padding:10px 12px; border-top:2px dashed var(--ksf-black); background:#fff}
    .hud .scores{display:flex; gap:10px; align-items:center}
    .score-chip{border:2px solid var(--ksf-black); padding:6px 10px; border-radius:999px; font-weight:700; background:#fff}
    .actions{display:flex; gap:8px;}
    button{cursor:pointer; font-weight:800; border:2px solid var(--ksf-black); border-radius:12px; padding:10px 12px; background:#fff; transition:transform .04s ease}
    button:active{transform:translateY(1px)}
    .primary{background:var(--ksf-yellow)}
    .ghost{background:#fff}
    .mint{background:var(--ksf-accent)}

    /* Nouvelles commandes mobiles : disposition demand√©e */
    .controls{display:grid; grid-template-areas: ". up ." "left down right" "replay replay replay"; grid-template-columns:1fr 1fr 1fr; gap:10px; padding:12px; background:#fff; border-top:2px dashed var(--ksf-black); justify-items:center; align-items:center}
    .controls button{width:64px;height:64px;font-size:22px;border:2px solid var(--ksf-black);border-radius:14px;background:#fff;touch-action:manipulation}
    .controls .up{grid-area:up}
    .controls .down{grid-area:down}
    .controls .left{grid-area:left}
    .controls .right{grid-area:right}
    .controls .replay{grid-area:replay;width:180px;height:50px;font-size:16px}

    /* Overlays */
    .overlay{position:absolute; inset:0; display:none; place-items:center; background:rgba(255,255,255,.9)}
    .overlay.active{display:grid}
    .panel{width:min(92%, 420px); background:#fff; border:2px solid var(--ksf-black); border-radius:16px; box-shadow:0 8px 0 var(--ksf-black); padding:16px}
    .panel h2{margin:.2rem 0 0.6rem}
    .panel p{margin:.5rem 0; line-height:1.35}
    .list{padding-left:18px}
    .center{display:flex; justify-content:center}
    .small{font-size:12px; opacity:.75}
    .muted{opacity:.8}

    .footer{padding:10px 12px; font-size:12px; background:#fff; border-top:2px dashed var(--ksf-black); display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap}
    .link{color:inherit}
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="header">
        <div class="brand">
          <img id="logo" alt="Logo" />
          <div class="title" id="brandTitle">KSF ‚Äì Mini Snake</div>
        </div>
        <div class="badges">
          <div class="badge">üéÅ Score du jour = surprise</div>
        </div>
      </div>

      <div class="canvas-wrap">
        <canvas id="game" width="400" height="500"></canvas>
        <!-- Overlays -->
        <div class="overlay active" id="startOverlay">
          <div class="panel">
            <h2>üéÆ Jouer √† Snake</h2>
            <p class="muted">Fais le meilleur score pendant l'attente. Montre ta capture √† la caisse pour tenter de gagner un <strong>cadeau</strong> üéÅ</p>
            <ul class="list">
              <li>Clavier: fl√®ches ou Z/Q/S/D</li>
              <li>Mobile: balayez l'√©cran (haut/bas/gauche/droite) ou utilisez les fl√®ches ci‚Äëdessous</li>
              <li>Pause / Reprendre: bouton ‚è∏Ô∏è / ‚ñ∂Ô∏è ou tape l√©ger</li>
            </ul>
            <div class="center" style="gap:8px; margin-top:10px">
              <button class="primary" id="btnStart">‚ñ∂Ô∏è Jouer</button>
              <button class="ghost" id="btnHow">‚ÑπÔ∏è R√®gles</button>
            </div>
          </div>
        </div>
        <div class="overlay" id="rulesOverlay">
          <div class="panel">
            <h2>‚ÑπÔ∏è R√®gles</h2>
            <p>Mange les fruits, √©vite les murs et ta propre queue. Chaque fruit = +1 point, la vitesse augmente r√©guli√®rement.</p>
            <p class="small">Astuce: anticipe tes virages üòâ</p>
            <div class="center" style="margin-top:10px">
              <button class="primary" id="btnBack">Ok, j'ai compris</button>
            </div>
          </div>
        </div>
        <div class="overlay" id="gameOverOverlay">
          <div class="panel" id="gameOverPanel">
            <h2>üí• Perdu !</h2>
            <p id="finalScore">Score: 0</p>
            <p id="bestScore">Meilleur: 0</p>
            <div class="center" style="gap:8px; margin-top:10px">
              <button class="primary" id="btnRestart">‚Üª Rejouer</button>
              <button class="mint" id="btnShare">Partager</button>
            </div>
            <p class="small muted" style="margin-top:10px">Astuce: ajoute le jeu √† ton √©cran d'accueil pour y rejouer plus tard üì≤</p>
          </div>
        </div>
      </div>

      <div class="hud">
        <div class="scores">
          <div class="score-chip">Score: <span id="score">0</span></div>
          <div class="score-chip">Best: <span id="hi">0</span></div>
        </div>
        <div class="actions">
          <button id="btnPause">‚è∏Ô∏è Pause</button>
          <a id="backLink" class="link" href="#" target="_self"><button class="ghost">‚¨ÖÔ∏è Linktree</button></a>
        </div>
      </div>

      <!-- Contr√¥les mobiles (layout demand√©) -->
      <div class="controls" id="controls">
        <button type="button" class="up" data-dir="up">‚¨ÜÔ∏è</button>
        <button type="button" class="down" data-dir="down">‚¨áÔ∏è</button>
        <button type="button" class="left" data-dir="left">‚¨ÖÔ∏è</button>
        <button type="button" class="right" data-dir="right">‚û°Ô∏è</button>
        <button type="button" class="replay" id="replayBtn">‚èØÔ∏è Start / Rejouer</button>
      </div>

      <div class="footer">
        <div>Insta: <strong>@Sowbella_France</strong> ‚Ä¢ <strong>@KSF_streetfood</strong></div>
        <div class="muted">Personnalis√© pour l'attente en file ‚Ä¢ HTML5 offline-ready</div>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const CONFIG = {
      brandTitle: 'KSF ‚Äì Mini Snake',
      logoUrl: '', // ex: 'https://.../logo.png' (laisser vide pour logo texte)
      linktreeBackUrl: 'https://linktr.ee/ksf_fr',
      grid: 20, // 20x20 cellules
      speedStartMs: 140, // vitesse initiale
      speedMinMs: 70, // min
      speedStepScore: 4, // acc√©l√©ration tous les X points
      hiStorageKey: 'ksfSnakeHighScore',
      theme: { snake: '#111111', head: '#000000', fruit: '#ff3b3b', board: '#fffdf0', gridLine: '#f3e9a2' }
    };

    // UI init
    const brandTitle = document.getElementById('brandTitle');
    const logo = document.getElementById('logo');
    const backLink = document.getElementById('backLink');
    brandTitle.textContent = CONFIG.brandTitle;
    backLink.href = CONFIG.linktreeBackUrl;
    if(CONFIG.logoUrl){ logo.src = CONFIG.logoUrl; logo.style.display='block'; }
    else{
      const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><rect width='64' height='64' rx='12' fill='%23FFD400' stroke='%23111' stroke-width='4'/><text x='50%' y='56%' text-anchor='middle' font-weight='900' font-size='28' fill='%23111' font-family='Arial, Helvetica, sans-serif'>KSF</text></svg>`);
      logo.src = `data:image/svg+xml;charset=utf-8,${svg}`; logo.style.display='block';
    }

    // Anti scroll / refresh mobile
    document.addEventListener('touchmove', (e)=>{ if(e.touches.length===1){ e.preventDefault(); } }, {passive:false});

    // Canvas & game state
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    let cell; // calcul√©e apr√®s resize
    const world = { size: CONFIG.grid };

    let snake, dir, nextDir, fruit, score, best, timer, speed;

    const startOverlay = document.getElementById('startOverlay');
    const rulesOverlay = document.getElementById('rulesOverlay');
    const gameOverOverlay = document.getElementById('gameOverOverlay');
    const scoreEl = document.getElementById('score');
    const hiEl = document.getElementById('hi');

    const btnStart = document.getElementById('btnStart');
    const btnHow = document.getElementById('btnHow');
    const btnBack = document.getElementById('btnBack');
    const btnRestart = document.getElementById('btnRestart');
    const btnShare = document.getElementById('btnShare');
    const btnPause = document.getElementById('btnPause');
    const btnReplay = document.getElementById('replayBtn');

    function loadBest(){ const v = parseInt(localStorage.getItem(CONFIG.hiStorageKey)||'0',10); best = isNaN(v)?0:v; hiEl.textContent = best; }
    function saveBest(){ localStorage.setItem(CONFIG.hiStorageKey, String(best)); }

    function reset(){
      snake = [ {x:10,y:10}, {x:9,y:10}, {x:8,y:10} ];
      dir = {x:1,y:0}; nextDir = {x:1,y:0};
      score = 0; scoreEl.textContent = score; speed = CONFIG.speedStartMs;
      spawnFruit(); draw();
    }

    function spawnFruit(){
      do{ fruit = { x: Math.floor(Math.random()*world.size), y: Math.floor(Math.random()*world.size) }; }
      while(snake.some(s=>s.x===fruit.x && s.y===fruit.y));
    }

    function drawCell(x,y,color){ ctx.fillStyle = color; ctx.fillRect(x*cell, y*cell, cell, cell); }
    function drawGrid(){ ctx.strokeStyle = CONFIG.theme.gridLine; ctx.lineWidth = 1; for(let i=0;i<=world.size;i++){ ctx.beginPath(); ctx.moveTo(i*cell,0); ctx.lineTo(i*cell, world.size*cell); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0,i*cell); ctx.lineTo(world.size*cell, i*cell); ctx.stroke(); } }

    function draw(){ ctx.fillStyle = CONFIG.theme.board; ctx.fillRect(0,0,canvas.width, canvas.height); drawGrid(); drawCell(fruit.x, fruit.y, CONFIG.theme.fruit); snake.forEach((s,i)=> drawCell(s.x,s.y, i===0?CONFIG.theme.head:CONFIG.theme.snake)); }

    function tick(){
      if((nextDir.x !== -dir.x) || (nextDir.y !== -dir.y)) dir = nextDir;
      const head = { x: snake[0].x + dir.x, y: snake[0].y + dir.y };
      if(head.x<0 || head.y<0 || head.x>=world.size || head.y>=world.size || snake.some(s=>s.x===head.x && s.y===head.y)) return gameOver();
      snake.unshift(head);
      if(head.x===fruit.x && head.y===fruit.y){
        score++; scoreEl.textContent = score; if(score>best){ best=score; hiEl.textContent=best; saveBest(); }
        if(score % CONFIG.speedStepScore === 0){ speed = Math.max(CONFIG.speedMinMs, speed-10); clearInterval(timer); timer = setInterval(tick, speed); }
        spawnFruit();
      } else { snake.pop(); }
      draw();
    }

    function play(){ clearInterval(timer); timer = setInterval(tick, speed); }
    function pause(){ clearInterval(timer); timer=null; }
    function togglePause(){ if(timer){ pause(); } else { play(); } updatePauseButtons(); }
    function updatePauseButtons(){ btnPause.textContent = timer? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Reprendre'; }

    function gameOver(){ pause(); document.getElementById('finalScore').textContent = 'Score: '+score; document.getElementById('bestScore').textContent = 'Meilleur: '+best; gameOverOverlay.classList.add('active'); }

    // ===== Clavier (desktop) =====
    const keyMap = { ArrowUp:{x:0,y:-1}, ArrowDown:{x:0,y:1}, ArrowLeft:{x:-1,y:0}, ArrowRight:{x:1,y:0}, KeyW:{x:0,y:-1}, KeyS:{x:0,y:1}, KeyA:{x:-1,y:0}, KeyD:{x:1,y:0} };
    window.addEventListener('keydown', (e)=>{ if(e.code==='Space'){ e.preventDefault(); togglePause(); return; } const nd = keyMap[e.code]; if(nd){ e.preventDefault(); nextDir = nd; } });

    // ===== Gestes tactiles (balayage + tape) =====
    let touchStart = null; const SWIPE_THRESHOLD = 18; // px
    function handleSwipe(dx, dy){
      if(Math.abs(dx) < SWIPE_THRESHOLD && Math.abs(dy) < SWIPE_THRESHOLD){ togglePause(); return; }
      if(Math.abs(dx) > Math.abs(dy)) nextDir = dx>0 ? {x:1,y:0} : {x:-1,y:0};
      else nextDir = dy>0 ? {x:0,y:1} : {x:0,y:-1};
    }
    function onPointerDown(ev){ const t = ev.touches ? ev.touches[0] : ev; touchStart = {x:t.clientX, y:t.clientY}; }
    function onPointerUp(ev){ if(!touchStart) return; const t = ev.changedTouches ? ev.changedTouches[0] : ev; const dx = t.clientX - touchStart.x; const dy = t.clientY - touchStart.y; touchStart = null; handleSwipe(dx, dy); }
    canvas.addEventListener('pointerdown', onPointerDown, {passive:true});
    canvas.addEventListener('pointerup', onPointerUp, {passive:true});
    canvas.addEventListener('touchstart', onPointerDown, {passive:true});
    canvas.addEventListener('touchend', onPointerUp, {passive:true});

    // ===== Boutons √† l'√©cran =====
    const dirMap = {up:{x:0,y:-1},down:{x:0,y:1},left:{x:-1,y:0},right:{x:1,y:0}};
    document.querySelectorAll('[data-dir]').forEach(btn=>{
      // Emp√™che tout scroll/refresh sur Android
      ['click','touchstart'].forEach(evt=> btn.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); } , {passive:false}) );
      btn.addEventListener('click', ()=>{ nextDir = dirMap[btn.dataset.dir]; });
      btn.addEventListener('touchend', (e)=>{ e.preventDefault(); nextDir = dirMap[btn.dataset.dir]; });
    });

    // ===== Buttons =====
    btnStart.addEventListener('click', ()=>{ startOverlay.classList.remove('active'); reset(); play(); updatePauseButtons(); });
    btnHow.addEventListener('click', ()=>{ startOverlay.classList.remove('active'); rulesOverlay.classList.add('active'); });
    btnBack.addEventListener('click', ()=>{ rulesOverlay.classList.remove('active'); startOverlay.classList.add('active'); });
    btnRestart.addEventListener('click', ()=>{ gameOverOverlay.classList.remove('active'); reset(); play(); updatePauseButtons(); });
    btnShare.addEventListener('click', async ()=>{ const text = `J'ai fait ${score} points au Snake KSF ! @Sowbella_France @KSF_streetfood`; try{ if(navigator.share){ await navigator.share({text, title:'KSF Snake', url: location.href}); } else { await navigator.clipboard.writeText(text); alert('Score copi√© ! Colle-le dans ta story Insta üì≤'); } }catch(err){} });
    btnPause.addEventListener('click', togglePause);
    btnReplay.addEventListener('click', ()=>{ if(startOverlay.classList.contains('active')){ startOverlay.classList.remove('active'); } if(gameOverOverlay.classList.contains('active')){ gameOverOverlay.classList.remove('active'); } reset(); play(); updatePauseButtons(); });

    // ===== Init & responsive =====
    function resizeCanvas(){ const w = document.querySelector('.canvas-wrap').clientWidth; const h = w*5/4; canvas.width = Math.round(w); canvas.height = Math.round(h); cell = Math.floor(Math.min(canvas.width, canvas.height) / CONFIG.grid); if(snake) draw(); }
    window.addEventListener('resize', resizeCanvas);
    function init(){ loadBest(); resizeCanvas(); updatePauseButtons(); }
    init();
  </script>
</body>
</html>
